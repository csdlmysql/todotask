#!/usr/bin/env node

// Task-Killer Executable Bundle
const path = require('path');
const os = require('os');
const fs = require('fs');

// Get the directory where the script is located
const scriptDir = path.dirname(require.main.filename);

// Setup config directory in user home
const homeDir = os.homedir();
const configDir = path.join(homeDir, '.task-killer');

if (!fs.existsSync(configDir)) {
    fs.mkdirSync(configDir, { recursive: true });
    
    // Create default .env
    const envContent = `# Task-Killer Configuration
GEMINI_API_KEY=your_gemini_api_key_here
DATABASE_URL=postgresql://localhost:5432/tasks
ENABLE_NOTIFICATIONS=true

# Optional: Telegram Bot (for notifications)
# TELEGRAM_BOT_TOKEN=your_bot_token
# TELEGRAM_CHAT_ID=your_chat_id
`;
    fs.writeFileSync(path.join(configDir, '.env'), envContent);
    console.log('üìù Created config at:', path.join(configDir, '.env'));
    console.log('‚ö†Ô∏è  Please edit .env and add your GEMINI_API_KEY');
    console.log('üîó Get API key: https://makersuite.google.com/app/apikey');
}

// Change to config directory for database files
process.chdir(configDir);

// Load environment from config directory
require('dotenv').config({ path: path.join(configDir, '.env') });

// Register TypeScript loader if available
const projectPath = path.dirname(require.main.filename);
try {
    // Try to use tsx from the project directory
    const tsxPath = path.join(projectPath, 'node_modules', 'tsx', 'cjs', 'index.js');
    if (fs.existsSync(tsxPath)) {
        require(tsxPath).register();
    } else {
        require('tsx/cjs').register();
    }
} catch (e) {
    console.warn('TSX not available, trying ts-node...');
    try {
        require('ts-node/register');
    } catch (e2) {
        console.error('Neither tsx nor ts-node available. Please run this from the project directory with tsx installed locally.');
        process.exit(1);
    }
}

// Start the application from the script directory
require('/Users/csdlmysql/p/mybots/taskkiller/src/index-smart.ts');
